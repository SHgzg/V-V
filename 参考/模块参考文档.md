# 个人知识管理（PKM）桌面系统架构设计文档

> 技术栈：Electron + TypeScript + 可插拔前端（Vue / React / 任意 Web 项目）
> 核心理念：**Git 作为事实源，AI 作为工具，Electron 作为宿主，前端完全解耦**

---

## 1. 项目背景与目标

本项目旨在构建一个**长期可演进的个人知识管理（PKM）桌面系统**，支持：

* 使用 **GitHub 仓库** 管理 Markdown 笔记
* 多仓库统一聚合到本地 Workspace
* 离线优先、本地编辑、可控同步
* 内置 Git（不依赖系统 git）
* 可接入 AI 进行整理、分类、润色等辅助工作
* 前端框架完全不受限制，可承载 PKM / Blog / Notebook / Diary 等多种前端应用

---

## 2. 总体架构概览

```
┌──────────────────────────────────────┐
│              Electron                │
│                                      │
│  ┌───────────────┐   ┌─────────────┐ │
│  │ Main Process  │   │ Renderer    │ │
│  │               │   │ Host        │ │
│  │ - WindowMgr   │   │             │ │
│  │ - GitAdapter  │   │ - AppLoader │ │
│  │ - FileService │   │ - Layout    │ │
│  │ - Indexer     │   │ - IPC Bridge│ │
│  └───────────────┘   └──────┬──────┘ │
│                              │        │
│                 ┌────────────┼────────────┐
│                 │            │            │
│            PKM App        Blog App     Diary App
│           (Vue/React)    (iframe)     (iframe)
└──────────────────────────────────────┘
```

---

## 3. 核心设计原则

### 3.1 架构原则

1. **Git 是唯一事实源（Source of Truth）**
2. **AI 永不直接写文件或操作 Git**
3. **Electron 只提供 OS 能力，不承载业务逻辑**
4. **前端应用可插拔、可并存、可替换**
5. **主进程是所有系统状态的裁决者**

---

## 4. Monorepo 项目结构

```
pkm-desktop/
├── apps/
│   └── desktop/              # Electron 应用
│       ├── main/             # 主进程
│       ├── preload/          # IPC Bridge
│       └── renderer-host/    # 前端宿主（极薄）
│
├── packages/
│   ├── core/                 # 领域核心（与 Electron 解耦）
│   ├── git-adapter/          # 内置 Git 引擎（isomorphic-git）
│   ├── ai/                   # AI 子系统
│   ├── indexer/              # Markdown 索引 / 搜索
│   ├── file-service/         # 文件读写封装
│   └── shared/               # 通用类型 / 工具
│
└── workspace/                # 用户本地工作区（运行时生成）
```

---

## 5. Workspace 设计

### 5.1 目录结构

```
~/.pkn/
├── repos/            # Git 仓库
│   ├── knowledge/
│   └── blog/
├── apps/             # 前端子应用
│   ├── pkm/
│   ├── blog/
│   └── diary/
├── index.sqlite      # 全文索引
├── layout.json       # 窗口布局
└── config.json       # 全局配置
```

---

## 6. Git 子系统（git-adapter）

### 6.1 设计目标

* 不依赖系统 git
* 纯 JS / TS 实现
* 行为可控、可测试
* 标准 Git 仓库结构

### 6.2 技术选型

* `isomorphic-git`

### 6.3 对外接口（GitService）

```ts
interface GitService {
  clone(repo): Promise<void>
  pull(repoId): Promise<void>
  status(repoId): Promise<GitStatus>
  commit(repoId, message): Promise<void>
  push(repoId): Promise<void>
  diff(repoId, filepath?): Promise<GitDiff>
}
```

---

## 7. AI 子系统设计

### 7.1 定位

* AI 是**辅助工具**，不是自动执行者
* 输出建议、摘要、分类、Patch

### 7.2 核心抽象

```ts
interface AITaskInput {
  type: 'summarize' | 'classify' | 'rewrite' | 'fix'
  content: string
}

interface AITaskResult {
  type: string
  output: string
}
```

### 7.3 AI Facade

* Prompt Builder
* Model Adapter（OpenAI / 自建 / 本地）
* 统一入口，支持演进

---

## 8. 前端宿主（Renderer Host）设计

### 8.1 核心定位

> Renderer Host 是 **前端运行环境**，不是业务 App

### 8.2 Frontend App 协议

```ts
interface FrontendApp {
  mount(container: HTMLElement, context: AppContext): void
  unmount(): void
}
```

### 8.3 Manifest 定义

```json
{
  "id": "blog",
  "name": "My Blog",
  "entry": "./index.html",
  "framework": "react"
}
```

---

## 9. 多窗口系统设计

### 9.1 WindowManager（主进程）

* 创建 / 销毁窗口
* 管理位置、尺寸、聚焦
* 保存 / 恢复布局

```ts
interface WindowDescriptor {
  id: string
  type: 'main' | 'editor' | 'preview' | 'search'
  bounds: Rectangle
}
```

### 9.2 拖拽与缩放

* 使用 `-webkit-app-region: drag`
* 主进程裁决窗口行为
* Renderer 只表达“意图”

---

## 10. 索引与搜索（Indexer）

* 扫描所有 Markdown 文件
* 提取标题、Heading、标签
* SQLite FTS / Lunr

索引为 **只读派生数据**，可随时重建

---

## 11. 数据流总览（关键）

```
Markdown → AI → 建议
                 ↓
           用户确认
                 ↓
           FileService
                 ↓
            Git Commit
                 ↓
              Index
```

---

## 12. 演进路线（建议）

### 阶段 1（MVP）

* 单仓库
* 单窗口
* Markdown 编辑 + Git 提交

### 阶段 2

* 多仓库
* 多窗口
* AI 摘要 / 润色

### 阶段 3

* Blog / Diary 子应用
* AI Patch / 分类
* 插件机制

---

## 13. 模块级设计文档（Module Design）

本节在总体架构之上，对各核心模块进行**职责、边界、接口层级**的进一步拆解，用于指导具体代码实现。

---

### 13.1 Electron 主进程（Main Process）

#### 职责

* 作为 **系统级裁决者**
* 管理窗口、文件系统、Git、索引、凭证
* 向 Renderer 提供受控能力（IPC）

#### 子模块

```
main/
├── window-manager/      # 多窗口系统
├── ipc/                 # IPC 路由与权限控制
├── services/
│   ├── git.service.ts
│   ├── file.service.ts
│   ├── index.service.ts
│   └── auth.service.ts
└── app.ts
```

#### 关键原则

* 主进程不包含 UI
* 所有“有副作用”的操作只能在主进程
* Renderer 只能通过 IPC 请求能力

---

### 13.2 WindowManager 模块

#### 职责

* BrowserWindow 生命周期管理
* 多窗口创建 / 销毁 / 聚焦
* 拖拽、缩放、布局恢复

#### 核心接口

```ts
interface WindowManager {
  create(desc: WindowDescriptor): string
  close(id: string): void
  focus(id: string): void
  updateBounds(id: string, bounds: Partial<Rectangle>): void
  saveLayout(): void
  restoreLayout(): void
}
```

#### 边界

* 不关心业务状态
* 不关心前端框架
* 只管理“窗口”这一 OS 概念

---

### 13.3 git-adapter 模块

#### 职责

* 内置 Git 实现（不依赖系统 git）
* 管理仓库状态、提交、同步

#### 技术基座

* isomorphic-git

#### 分层结构

```
git-adapter/
├── engine/      # isomorphic-git 封装
├── domain/      # Git 领域模型
├── service/     # GitService 对外接口
└── index.ts
```

#### 核心接口

```ts
interface GitService {
  clone(repo): Promise<void>
  pull(repoId): Promise<void>
  status(repoId): Promise<GitStatus>
  commit(repoId, message: string): Promise<void>
  push(repoId): Promise<void>
}
```

#### 关键约束

* 永远生成标准 Git 仓库
* 禁止 force push / rebase（第一阶段）

---

### 13.4 FileService 模块

#### 职责

* 统一文件读写
* 变更监听
* 提供 Diff / Patch 应用能力

#### 接口示例

```ts
interface FileService {
  read(path: string): Promise<string>
  write(path: string, content: string): Promise<void>
  applyPatch(path: string, patch: string): Promise<void>
}
```

---

### 13.5 AI 子系统（packages/ai）

#### 职责

* 将 AI 能力封装为“任务”
* 统一 Prompt / Adapter / Result

#### 核心分层

```
ai/
├── facade.ts
├── tasks/
├── adapters/
└── prompt/
```

#### 关键原则

* AI 不直接修改文件
* AI 输出必须可审阅、可拒绝

---

### 13.6 Indexer 模块

#### 职责

* 扫描 Markdown
* 建立全文索引
* 支持搜索与跳转

#### 特点

* 只读派生数据
* 可随时重建

---

### 13.7 Renderer Host（前端宿主）

#### 职责

* 加载 / 卸载前端子应用
* 提供 AppContext
* 管理布局容器

#### 核心接口

```ts
interface FrontendHost {
  load(manifest: FrontendAppManifest): Promise<void>
  unload(appId: string): void
}
```

---

### 13.8 前端子应用（PKM / Blog / Diary）

#### 约束

* 必须实现 FrontendApp 协议
* 不直接依赖 Electron API

#### 生命周期

```
load → mount → active → unmount → unload
```

---

## 14. 架构裁判规则（Architecture Guardrails）

1. 新功能必须归属某一模块
2. 不允许跨模块直接依赖
3. AI / Git / Window 为三条独立主线
4. Renderer 永远是“消费者”

---

## 15. 下一步实施建议

**推荐优先级：**

1. WindowManager（主进程基础设施）
2. git-adapter（数据可信度核心）
3. Renderer Host（前端解耦关键）

---

## 16. 总结

这份模块级设计文档用于：

* 指导代码目录与依赖方向
* 防止架构腐化
* 支撑长期演进与重构

**当实现与文档冲突时，应优先修正文档，而不是随意改代码。**
