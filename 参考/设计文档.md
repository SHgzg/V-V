# 个人知识管理（PKM）桌面系统架构设计文档

> 技术栈：Electron + TypeScript + 可插拔前端（Vue / React / 任意 Web 项目）
> 核心理念：**Git 作为事实源，AI 作为工具，Electron 作为宿主，前端完全解耦**

---

## 1. 项目背景与目标

本项目旨在构建一个**长期可演进的个人知识管理（PKM）桌面系统**，支持：

* 使用 **GitHub 仓库** 管理 Markdown 笔记
* 多仓库统一聚合到本地 Workspace
* 离线优先、本地编辑、可控同步
* 内置 Git（不依赖系统 git）
* 可接入 AI 进行整理、分类、润色等辅助工作
* 前端框架完全不受限制，可承载 PKM / Blog / Notebook / Diary 等多种前端应用

---

## 2. 总体架构概览

```
┌──────────────────────────────────────┐
│              Electron                │
│                                      │
│  ┌───────────────┐   ┌─────────────┐ │
│  │ Main Process  │   │ Renderer    │ │
│  │               │   │ Host        │ │
│  │ - WindowMgr   │   │             │ │
│  │ - GitAdapter  │   │ - AppLoader │ │
│  │ - FileService │   │ - Layout    │ │
│  │ - Indexer     │   │ - IPC Bridge│ │
│  └───────────────┘   └──────┬──────┘ │
│                              │        │
│                 ┌────────────┼────────────┐
│                 │            │            │
│            PKM App        Blog App     Diary App
│           (Vue/React)    (iframe)     (iframe)
└──────────────────────────────────────┘
```

---

## 3. 核心设计原则

### 3.1 架构原则

1. **Git 是唯一事实源（Source of Truth）**
2. **AI 永不直接写文件或操作 Git**
3. **Electron 只提供 OS 能力，不承载业务逻辑**
4. **前端应用可插拔、可并存、可替换**
5. **主进程是所有系统状态的裁决者**

---

## 4. Monorepo 项目结构

```
pkm-desktop/
├── apps/
│   └── desktop/              # Electron 应用
│       ├── main/             # 主进程
│       ├── preload/          # IPC Bridge
│       └── renderer-host/    # 前端宿主（极薄）
│
├── packages/
│   ├── core/                 # 领域核心（与 Electron 解耦）
│   ├── git-adapter/          # 内置 Git 引擎（isomorphic-git）
│   ├── ai/                   # AI 子系统
│   ├── indexer/              # Markdown 索引 / 搜索
│   ├── file-service/         # 文件读写封装
│   └── shared/               # 通用类型 / 工具
│
└── workspace/                # 用户本地工作区（运行时生成）
```

---

## 5. Workspace 设计

### 5.1 目录结构

```
~/.pkn/
├── repos/            # Git 仓库
│   ├── knowledge/
│   └── blog/
├── apps/             # 前端子应用
│   ├── pkm/
│   ├── blog/
│   └── diary/
├── index.sqlite      # 全文索引
├── layout.json       # 窗口布局
└── config.json       # 全局配置
```

---

## 6. Git 子系统（git-adapter）

### 6.1 设计目标

* 不依赖系统 git
* 纯 JS / TS 实现
* 行为可控、可测试
* 标准 Git 仓库结构

### 6.2 技术选型

* `isomorphic-git`

### 6.3 对外接口（GitService）

```ts
interface GitService {
  clone(repo): Promise<void>
  pull(repoId): Promise<void>
  status(repoId): Promise<GitStatus>
  commit(repoId, message): Promise<void>
  push(repoId): Promise<void>
  diff(repoId, filepath?): Promise<GitDiff>
}
```

---

## 7. AI 子系统设计

### 7.1 定位

* AI 是**辅助工具**，不是自动执行者
* 输出建议、摘要、分类、Patch

### 7.2 核心抽象

```ts
interface AITaskInput {
  type: 'summarize' | 'classify' | 'rewrite' | 'fix'
  content: string
}

interface AITaskResult {
  type: string
  output: string
}
```

### 7.3 AI Facade

* Prompt Builder
* Model Adapter（OpenAI / 自建 / 本地）
* 统一入口，支持演进

---

## 8. 前端宿主（Renderer Host）设计

### 8.1 核心定位

> Renderer Host 是 **前端运行环境**，不是业务 App

### 8.2 Frontend App 协议

```ts
interface FrontendApp {
  mount(container: HTMLElement, context: AppContext): void
  unmount(): void
}
```

### 8.3 Manifest 定义

```json
{
  "id": "blog",
  "name": "My Blog",
  "entry": "./index.html",
  "framework": "react"
}
```

---

## 9. 多窗口系统设计

### 9.1 WindowManager（主进程）

* 创建 / 销毁窗口
* 管理位置、尺寸、聚焦
* 保存 / 恢复布局

```ts
interface WindowDescriptor {
  id: string
  type: 'main' | 'editor' | 'preview' | 'search'
  bounds: Rectangle
}
```

### 9.2 拖拽与缩放

* 使用 `-webkit-app-region: drag`
* 主进程裁决窗口行为
* Renderer 只表达“意图”

---

## 10. 索引与搜索（Indexer）

* 扫描所有 Markdown 文件
* 提取标题、Heading、标签
* SQLite FTS / Lunr

索引为 **只读派生数据**，可随时重建

---

## 11. 数据流总览（关键）

```
Markdown → AI → 建议
                 ↓
           用户确认
                 ↓
           FileService
                 ↓
            Git Commit
                 ↓
              Index
```

---

## 12. 演进路线（建议）

### 阶段 1（MVP）

* 单仓库
* 单窗口
* Markdown 编辑 + Git 提交

### 阶段 2

* 多仓库
* 多窗口
* AI 摘要 / 润色

### 阶段 3

* Blog / Diary 子应用
* AI Patch / 分类
* 插件机制

---

## 13. 总结

该架构保证：

* 不锁定任何前端框架
* 不绑定任何 AI 服务商
* 不依赖用户系统环境
* 支持长期、渐进式演进

**Electron 只是壳，Git 是核心，前端是插件，AI 是工具。**
