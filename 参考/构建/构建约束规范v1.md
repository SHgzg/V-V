# V-V PKM 构建约束规范 v1

> 本文档定义 **V-V PKM Desktop** 在 2025–2027 阶段的**构建边界、包约束与演进原则**。
>
> 目标不是追求最先进技术，而是：
> **可预测、可扩展、可长期维护、不反噬架构。**

---

## 1. 规范适用范围

本规范适用于以下所有模块：

* `apps/desktop/**`

  * Electron 主进程（main）
  * preload 脚本
  * renderer host
* `packages/@v-v/*`

  * git-adapter
  * window-manager
  * ai-adapter（未来）
  * indexer / shared 等

**不适用于**：

* 独立运行的 Web 项目（Blog / Diary 前端）
* 第三方插件（仅作为参考）

---

## 2. 核心构建哲学（必须遵守）

### 2.1 Electron ≠ Web App

* 主进程 / preload 是 **Node 程序**
* renderer 是 **浏览器程序**
* 三者必须 **构建、依赖、运行时完全隔离**

❌ 禁止将 Electron 当成「带 Node 的 Web 应用」

---

### 2.2 内部包是「运行时库」，不是「打包产物」

所有 `@v-v/*` 包：

* 以 **Node 运行时加载** 为前提
* 不参与 Electron main/preload 的 bundle
* 必须可以被 `require()` 正确加载

> 内部包不是 Rollup 的输入，而是 Node 的依赖

---

## 3. Package 构建强制约束（最重要部分）

### 3.1 包类型分级

所有 `@v-v/*` 包 **必须声明自己的级别**：

| 等级 | 含义           | 示例               |
| -- | ------------ | ---------------- |
| L0 | 纯类型 / 常量     | `shared`         |
| L1 | Node 运行时库    | `git-adapter`    |
| L2 | Electron 专属库 | `window-manager` |

禁止未声明级别的包存在。

---

### 3.2 强制 package.json 规范

#### L0 / L1 / L2 包 **统一要求**：

```json
{
  "type": "commonjs",
  "main": "dist/index.js",
  "exports": {
    ".": "./dist/index.js"
  },
  "sideEffects": false
}
```

**解释**：

* `type: commonjs`：

  * 当前阶段禁止 ESM-only 包
* `exports`：

  * 防止深路径 import
* `sideEffects: false`：

  * 为未来 tree-shaking 留接口

---

### 3.3 构建产物约束

* 所有 package **必须先构建，再被 Electron 使用**
* Electron **不得直接引用 packages/src**

❌ 禁止以下行为：

```ts
import '../packages/git-adapter/src'
```

---

## 4. external 策略规范

### 4.1 external 的“法律定义”

> **external = 你承诺该模块在 Node 运行时一定存在**

因此：

* ❌ 不允许对「未构建完成的包」external
* ❌ 不允许 external ESM-only 包

---

### 4.2 external 白名单机制（推荐）

Electron main / preload 中：

```ts
external: [
  'electron',
  '@v-v/shared',
  '@v-v/git-adapter',
  '@v-v/window-manager'
]
```

❌ 禁止使用宽泛正则：

```ts
/^@v-v\//
```

理由：

* 无法控制包的构建状态
* 无法控制模块格式

---

### 4.3 externalizeDepsPlugin 的地位

* 它是 **辅助工具**
* 不是架构核心
* 不得代替人工 external 决策

---

## 5. hoist 策略约束（非常重要）

### 5.1 总原则

> **禁止使用 `shamefully-hoist=true` 作为长期方案**

---

### 5.2 允许的 hoist 范围

```ini
shamefully-hoist=false
public-hoist-pattern[]=electron
public-hoist-pattern[]=electron-builder
```

理由：

* Electron 运行时要求
* 不破坏 pnpm 的依赖隔离

---

## 6. Sourcemap 与调试规范

### 6.1 开发环境

* main / preload：`inline-source-map`
* renderer：Vite 默认

---

### 6.2 生产环境

| 模块       | sourcemap 策略  |
| -------- | ------------- |
| main     | ❌ 关闭 或 hidden |
| preload  | hidden        |
| renderer | 保留            |

理由：

* 避免泄露源码路径
* 避免用户环境路径错乱

---

## 7. 禁止行为清单（红线）

以下行为 **视为架构违规**：

* ❌ Electron main/preload 直接 import ESM-only 包
* ❌ Renderer require Node 内部包
* ❌ workspace 包未构建即运行
* ❌ 正则 external 全 workspace
* ❌ AI / 插件直接操作文件系统绕过 git-adapter

---

## 8. 演进策略（为未来留门）

### 8.1 ESM 化的前置条件

只有在以下条件满足后，才允许整体 ESM 迁移：

1. Node LTS ≥ 20
2. Electron 主进程完全 ESM 支持稳定
3. 所有 @v-v 包支持 dual build

---

### 8.2 插件系统的构建原则（预告）

* 插件 = 独立 Node 包
* 插件 **不参与主构建**
* 插件运行在受限上下文

---

## 9. 规范地位说明

* 本文档是 **强约束文档**
* 新模块必须满足本规范
* 不符合规范的实现：

  * 必须说明原因
  * 必须有迁移计划

---

## 10. 结语

> 技术选型可以变化，
> 但 **边界一旦模糊，系统就会腐化**。

本规范的目的不是限制开发速度，
而是确保 **V-V PKM 在 3–5 年后仍然可维护、可演进、不失控**。
