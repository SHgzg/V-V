# V-V PKM 插件与子前端构建隔离规范 v1

> 本文档定义 **V-V PKM Desktop** 中：
>
> * 插件系统（Plugin System）
> * 子前端 / 外挂前端（Sub-Frontend）
>
> 的 **构建、运行、依赖、权限边界**。
>
> 目标：
> **前端与功能可以无限扩展，但主应用永不失控。**

---

## 1. 核心设计结论（先给结论）

> **插件 ≠ 子前端 ≠ Renderer 主应用**

三者在架构上必须严格区分，否则：

* 构建会坍塌
* 依赖会污染
* Electron 安全模型会失效

---

## 2. 角色定义

### 2.1 Renderer Host（主渲染器）

* 桌面应用的核心 UI Shell
* 负责：

  * 窗口管理
  * 路由分发
  * 插件挂载
  * 子前端加载

**特征**：

* 单一实例
* 随桌面 App 构建发布

---

### 2.2 插件（Plugin）

> 插件是 **Node 侧能力扩展单元**

* 运行位置：

  * Electron main
  * 或 isolated Node Worker

* 能力：

  * 操作数据
  * 调用 git-adapter
  * 调用 ai-adapter

❌ 插件 **不直接渲染 UI**

---

### 2.3 子前端（Sub-Frontend）

> 子前端是 **UI 能力扩展单元**

* 本质：

  * 独立前端应用

* 技术栈：

  * Vue / React / Svelte / 任意框架

* 加载方式：

  * iframe
  * WebView
  * 或独立 BrowserWindow

---

## 3. 插件系统规范（Node 侧）

### 3.1 插件的本质

插件是一个 **独立 Node 包**：

```txt
plugin-example/
├── package.json
├── dist/index.js
└── manifest.json
```

---

### 3.2 插件 package.json 强制规范

```json
{
  "name": "@v-v/plugin-example",
  "type": "commonjs",
  "main": "dist/index.js",
  "exports": {
    ".": "./dist/index.js"
  }
}
```

---

### 3.3 插件入口约束

```ts
export function activate(ctx: PluginContext) {}
export function deactivate() {}
```

* 插件 **不能自行启动进程**
* 插件 **不能持有全局状态**

---

### 3.4 插件权限模型（第一阶段）

插件只能通过 `PluginContext` 访问能力：

```ts
interface PluginContext {
  git: GitAdapter
  ai?: AiAdapter
  storage: ScopedStorage
  events: EventBus
}
```

❌ 禁止：

* 直接访问 fs
* 直接访问 network

---

## 4. 子前端系统规范（UI 侧）

### 4.1 子前端的构建独立性

> 子前端 **永远不参与主应用构建**

* 不进入 monorepo
* 不被 electron-vite 处理
* 不共享 node_modules

---

### 4.2 子前端的加载模型

推荐优先级：

1. iframe（最安全）
2. WebView
3. 独立 BrowserWindow

---

### 4.3 与主应用通信方式

唯一合法通道：

```txt
postMessage / IPC Bridge
```

禁止：

* 共享全局变量
* 直接访问 preload API

---

## 5. 构建隔离原则（核心）

### 5.1 构建边界图

```txt
Main / Preload
   │
   │  require
   ▼
Plugin (Node)

Renderer Host
   │
   │  mount
   ▼
Sub-Frontend (Web)
```

---

### 5.2 依赖禁止流向

| From         | To       | 允许     |
| ------------ | -------- | ------ |
| Plugin       | Renderer | ❌      |
| Sub-Frontend | Plugin   | ❌      |
| Renderer     | Plugin   | ✅（IPC） |

---

## 6. 构建工具策略

### 6.1 插件构建

* 使用 tsup / tsc
* 输出 Node 可执行 CJS

---

### 6.2 子前端构建

* 自由使用：

  * Vite
  * Next.js
  * Astro

* 输出：

  * 静态文件

---

## 7. 生命周期管理

### 7.1 插件生命周期

```txt
load → activate → deactivate → unload
```

由主进程统一管理。

---

### 7.2 子前端生命周期

* mount
* unmount
* reload

由 Renderer Host 管理。

---

## 8. 安全红线（不可违反）

* ❌ 插件访问用户主文件系统
* ❌ 子前端执行 Node API
* ❌ 插件动态 require 未声明依赖
* ❌ Renderer 执行插件代码

---

## 9. 演进预留

### 9.1 插件沙箱化（v2）

* Node VM
* Worker Thread

---

### 9.2 子前端市场（v3）

* 插件声明 UI
* 子前端远程加载

---

## 10. 结语

> 架构的成功不在于功能多少，
> 而在于 **边界是否不可被无意突破**。

本规范的目标是：
**让 V-V PKM 可以无限扩展，而不会在某一天必须推倒重来。**
