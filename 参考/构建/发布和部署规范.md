# V-V PKM Desktop 发布与部署架构规范 v1

> 本文档定义 V-V PKM Desktop 的最终构建物料结构、发布形态、GitHub Release 集成方式以及自动更新机制。
> 目标是建立长期稳定、可审计、可演进的发布体系。

---

# 一、产物分层模型

V-V PKM 的发布体系分为三个层级：

| 层级 | 名称                     | 用途        |
| -- | ---------------------- | --------- |
| L1 | 构建产物（Build Artifact）   | CI 内部构建输出 |
| L2 | 发布包（Release Artifact）  | 用户下载与安装   |
| L3 | 更新增量包（Update Artifact） | 自动更新机制    |

---

# 二、构建产物结构（L1）

CI 构建完成后，应生成完整的可运行内核目录：

```
dist/
├── main/
├── preload/
├── renderer/
├── runtime/
│   └── node_modules/
├── manifest.json
└── package.json
```

## 设计原则

1. dist 必须是“可运行”的完整结构
2. 所有 external 模块必须显式存在于 runtime/node_modules
3. manifest.json 记录：

   * 构建时间
   * Git commit hash
   * 核心模块版本
   * 产物 hash

> 原则：dist 拷贝到干净机器应可直接运行

---

# 三、发布物料结构（L2）

使用 electron-builder 生成平台级安装包。

## Windows

```
V-V-PKM-Setup-1.0.0.exe
V-V-PKM-1.0.0-win.zip
latest.yml
```

## macOS

```
V-V-PKM-1.0.0.dmg
V-V-PKM-1.0.0-mac.zip
latest-mac.yml
```

## Linux

```
V-V-PKM-1.0.0.AppImage
```

---

# 四、发布驱动机制

## 1. Git Tag 作为唯一发布入口

```
git tag v1.0.0
git push origin v1.0.0
```

禁止手动上传发布物。

## 2. GitHub Actions 自动流程

触发后执行：

1. 安装依赖
2. 构建 workspace
3. 生成 dist
4. electron-builder 打包
5. 上传至 GitHub Release

---

# 五、GitHub Release 结构

```
Release v1.0.0
├── V-V-PKM-Setup-1.0.0.exe
├── V-V-PKM-1.0.0-win.zip
├── latest.yml
├── V-V-PKM-1.0.0.dmg
├── latest-mac.yml
└── checksums.txt
```

Release 页面作为：

* 分发源
* 更新源
* 版本归档

---

# 六、自动更新机制（L3）

使用 electron-updater。

## 工作流程

```
App 启动
   ↓
checkForUpdates()
   ↓
读取 latest.yml
   ↓
版本比较
   ↓
下载增量包
   ↓
静默更新
```

## 关键配置

package.json:

```json
{
  "build": {
    "publish": [
      {
        "provider": "github",
        "owner": "your-name",
        "repo": "V-V"
      }
    ]
  }
}
```

main 进程：

```ts
import { autoUpdater } from 'electron-updater'

autoUpdater.checkForUpdatesAndNotify()
```

---

# 七、插件发布策略（长期规划）

## 主应用

负责：

* Electron Runtime
* git-adapter
* window-manager
* AI adapter

## 插件

* 独立仓库
* 独立版本号
* 独立 GitHub Release
* 主应用远程下载并安装

插件安装目录：

```
userData/plugins/
```

---

# 八、版本策略

使用 SemVer 语义化版本：

* patch：Bug 修复
* minor：新增功能
* major：数据结构或核心能力变更

版本号唯一来源：Git Tag。

---

# 九、部署完整链路

```
git tag
   ↓
GitHub Action
   ↓
build + package
   ↓
GitHub Release
   ↓
用户安装
   ↓
autoUpdater 检查更新
```

---

# 十、架构结论

通过 GitHub Release + electron-builder + autoUpdater 的组合，V-V PKM 获得：

* 无需自建更新服务器
* 完整版本历史
* 可审计发布流程
* 支持增量更新
* 插件生态可扩展

此发布体系作为长期稳定架构，不依赖具体构建工具，可随技术栈演进而保持结构不变。

---

# 十一、GitHub Actions 完整 CI/CD 模板

以下为标准跨平台构建与发布流程模板（基于 Tag 触发）。

## 触发规则

```yaml
name: Release

on:
  push:
    tags:
      - 'v*'
```

---

## 完整工作流示例

```yaml
name: Build and Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build:
    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        os: [windows-latest, macos-latest, ubuntu-latest]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Build Workspace
        run: npm run build

      - name: Build Electron App
        run: npm run build:electron

      - name: Package Application
        run: npm run dist
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Artifacts (optional)
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ matrix.os }}
          path: dist/**
```

---

# 十二、package.json 推荐脚本

```json
{
  "scripts": {
    "build": "turbo run build",
    "build:electron": "electron-vite build",
    "dist": "electron-builder"
  }
}
```

---

# 十三、electron-builder 基础配置

```json
{
  "build": {
    "appId": "com.vv.pkm",
    "productName": "V-V PKM",
    "files": [
      "dist/**/*"
    ],
    "directories": {
      "output": "release"
    },
    "publish": [
      {
        "provider": "github",
        "owner": "your-name",
        "repo": "your-repo"
      }
    ],
    "win": {
      "target": "nsis"
    },
    "mac": {
      "target": "dmg"
    },
    "linux": {
      "target": "AppImage"
    }
  }
}
```

---

# 十四、密钥与安全

需要在 GitHub 仓库设置：

* GITHUB_TOKEN（默认存在）
* Windows 代码签名证书（可选）
* macOS Developer ID（如需公证）

---

# 十五、发布链路总结

```
Git Tag → GitHub Action → 构建 → 打包 → 上传 Release → 自动更新
```

CI 必须作为唯一发布通道，禁止本地人工构建并上传。
