
---

# Electron 多模块可拖拽分屏设计文档

## 一、功能概述

该功能允许在 **单个 Electron 窗口内**创建多个独立模块（面板 / 编辑器 / 插件窗口），实现：

* 自由拖拽分割屏幕
* 水平/垂直拆分、合并面板
* Tab 管理、分屏切换
* 每个模块独立渲染进程，保证性能
* 布局可持久化，支持重启恢复

**参考 VSCode 编辑器布局**

---

## 二、技术选型

| 组件    | 技术/API                 | 说明                          |
| ----- | ---------------------- | --------------------------- |
| 主窗口   | BrowserWindow          | Electron 创建的物理窗口            |
| 子模块   | BrowserView            | 每个模块独立渲染进程                  |
| 布局管理  | Layout Manager         | SplitNode 树管理分屏和比例          |
| 拖拽分割  | 鼠标事件 + SplitNode ratio | 实时更新 BrowserView 的 bounds   |
| 布局持久化 | JSON                   | 保存每个 BrowserView 位置、大小和 URL |

> macOS 可使用 `contentView.addChildView` 替代 BrowserView，但 BrowserView 跨平台更稳

---

## 三、布局数据结构

```ts
type SplitDirection = 'horizontal' | 'vertical'

interface SplitNode {
  id: string
  type: 'split' | 'view'           // 分割节点或单个模块
  direction?: SplitDirection       // type==='split' 时
  ratio?: number                   // 左/上占比
  children?: SplitNode[]           // 分割节点的子节点
  view?: BrowserView               // type==='view' 时对应 BrowserView
  url?: string                     // 加载内容
}
```

**示例布局 JSON**

```json
{
  "id": "root",
  "type": "split",
  "direction": "vertical",
  "ratio": 0.6,
  "children": [
    { "id": "editor1", "type": "view", "url": "file:///editor1.html" },
    {
      "id": "split2",
      "type": "split",
      "direction": "horizontal",
      "ratio": 0.5,
      "children": [
        { "id": "editor2", "type": "view", "url": "file:///editor2.html" },
        { "id": "terminal", "type": "view", "url": "file:///terminal.html" }
      ]
    }
  ]
}
```

* 左侧占 60%，右侧占 40%
* 右侧再横向拆分成两个模块，各占 50%

---

## 四、BrowserView 管理

### 1. 创建模块

```ts
const view = new BrowserView()
view.webContents.loadURL(url)
mainWindow.addBrowserView(view)
```

### 2. 更新模块位置和大小

```ts
view.setBounds({ x: number, y: number, width: number, height: number })
```

* 拖拽分割条或调整比例时动态调用 `setBounds`
* 每个 BrowserView 独立渲染，不阻塞主窗口

### 3. 布局树递归更新

```ts
function updateBounds(node: SplitNode, bounds: {x:number,y:number,w:number,h:number}) {
  if(node.type === 'view' && node.view) {
    node.view.setBounds(bounds)
  } else if(node.type === 'split' && node.children) {
    const [c1, c2] = node.children
    if(node.direction === 'vertical') {
      const w1 = bounds.w * (node.ratio ?? 0.5)
      updateBounds(c1, { x: bounds.x, y: bounds.y, w: w1, h: bounds.h })
      updateBounds(c2, { x: bounds.x + w1, y: bounds.y, w: bounds.w - w1, h: bounds.h })
    } else { // horizontal
      const h1 = bounds.h * (node.ratio ?? 0.5)
      updateBounds(c1, { x: bounds.x, y: bounds.y, w: bounds.w, h: h1 })
      updateBounds(c2, { x: bounds.x, y: bounds.y + h1, w: bounds.w, h: bounds.h - h1 })
    }
  }
}
```

---

## 五、拖拽分割实现

1. **捕获鼠标事件**

   * 鼠标按下 `mousedown` → 记录拖拽开始位置
   * 鼠标移动 `mousemove` → 计算新的分割比例，更新 `SplitNode.ratio`
   * 鼠标抬起 `mouseup` → 结束拖拽

2. **更新布局**

   * 拖拽过程中调用 `updateBounds(root, mainWindow.getBounds())`
   * 实时更新 BrowserView 大小

3. **支持多方向分割**

   * 垂直分割：左右模块
   * 水平分割：上下模块
   * 可嵌套实现多行多列布局

---

## 六、Tab 管理与拆分/合并

* 每个 BrowserView 可放入 **Tab 容器**
* 拖动 Tab → 新建 SplitNode → 拆分为新分屏
* 合并 Tab → 删除 SplitNode → 更新父节点 ratio
* 支持拖拽 Tab 在不同分屏间移动

---

## 七、布局持久化

1. **存储**

   * 保存每个 BrowserView 的 `id, bounds, url, tab状态`
   * 保存 SplitNode 树结构为 JSON

2. **恢复**

   * 启动主窗口时读取 JSON
   * 创建 BrowserView 并调用 `updateBounds(root, mainWindow.getBounds())`

---

## 八、优势与设计价值

| 特性     | 优势                                    |
| ------ | ------------------------------------- |
| 独立渲染   | 每个模块独立 BrowserView，不卡主线程              |
| 拖拽分割   | 用户可自由调整布局，体验类 VSCode                  |
| Tab 支持 | 模块可多实例、可拆分、可合并                        |
| 跨平台    | BrowserView 在 Windows/macOS/Linux 都可用 |
| 布局持久化  | 用户布局状态可重启恢复，支持多工作区                    |

---

## 九、可选优化

* **最小化/最大化模块** → 通过调整 SplitNode ratio
* **动态加载插件** → 每个 BrowserView 可以加载独立 HTML / JS
* **布局动画** → 拖拽时添加平滑动画，提高体验
* **键盘快捷操作** → 类 VSCode 快捷键切换焦点/分屏
* **分屏树缓存** → 快速重排布局，避免每次都递归计算 bounds

---

✅ **总结**

该方案结合了 Electron **BrowserView** 的独立渲染特性与 **布局树管理**，实现 VSCode 风格的可拖拽分屏、可自由调整大小的模块化布局，支持 Tab 拆分、合并与持久化，跨平台可用，性能和可扩展性均优秀。

---
